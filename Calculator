#define _CRT_SECURE_NO_WARNINGS
#include "calculator.h"

// Definition and initialization of the global variables to store the last two results (R and P)
double last_result = 0.0;
double prev_result = 0.0; // New variable P for the result before R

/**
 * @brief Main function to run the advanced calculator program.
 * The program runs in a loop until the user chooses to exit.
 */
int main() {
    int choice = 0;
    double top_level_result = NAN; // Variable to capture the result of the top-level operation

    printf("--- Welcome to the Advanced Calculator ---\n");
    printf("Developed by Amir for University Course Project.\n");
    printf("Note: You can use 'R' (Last Result), 'P' (Previous Result), or enter a menu number (1, 2, 3) for a nested calculation when prompted for numerical input.\n"); // Updated Note

    // Main program loop
    while (choice != 5) {
        display_menu();
        choice = get_menu_choice(5);

        if (choice == -1) {
            // Invalid input, loop continues to redisplay menu
            continue;
        }

        top_level_result = NAN; // Reset result at the start of loop iteration

        switch (choice) {
        case 1:
            // Mathematical Operations (Now returns the result)
            top_level_result = handle_math_operations();
            break;
        case 2:
            // Trigonometric Operations (Now returns the result)
            top_level_result = handle_trig_operations();
            break;
        case 3:
            // Number System Conversions (Now returns the result)
            top_level_result = handle_conversion_operations();
            break;
        case 4:
            // Clear/Restart option (resets R and P)
            last_result = 0.0;
            prev_result = 0.0; // Reset P as well
            printf("\n--- Calculator Cleared. Result history (R and P) reset to 0.0000. Ready for a new calculation! ---\n");
            break;
        case 5:
            // Exit option
            printf("\n--- Exiting Calculator. Goodbye! ---\n");
            break;
        default:
            // Should be caught by get_menu_choice, but for safety:
            printf("An unexpected error occurred. Please try again.\n");
            break;
        }

        // Only update R and P if the top-level operation successfully returned a number
        if (!isnan(top_level_result)) {
            update_results(top_level_result);
        }
    }

    return 0;
}
